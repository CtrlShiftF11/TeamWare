<!-- Andy Sandefer -->
<!DOCTYPE html>
<html>
<%= include partials/navmenu %>
<head>
    <script src="../javascripts/coverflow.min.js"></script>
    <script src="../javascripts/highcharts.js"></script>
    <script src="/javascripts/highmaps.js"></script>
    <script src="/javascripts/treemap.js"></script>
    <!--<script src="../javascripts/charts/actualvsplannedbyproject.js"></script>-->
    <!--<script src="../javascripts/charts/sprintsbyproject.js"></script>-->

    <link rel="stylesheet" type="text/css" href="../stylesheets/coverflow/coverflow.css"/>

    <style>
        .projectTile {
            width: 180px;
            height: 130px;
            border-style: solid;
            border-width: 1px;
            background: linear-gradient(#000000, gray);
            border-color: gray;
            border-radius: 6px;
            color: white;
            text-align: center;
        }

        .projectTileSelected {
            background: linear-gradient(#ffffff, gray);
            border-color: gray;
            border-radius: 6px;
            color: black;
            text-align: center;
        }

        .microChart {
            width: 400px;
            height: 300px;
            float: left;
            border-style: solid;
            border-width: 1px;
            border-radius: 6px;
            margin-right: 6px;
            padding: 6px;;
        }

        #reportFilters {
            float: left;
            margin-right: 10px;
            border-style: solid;
            border-width: 1px;
            border-radius: 6px;
            padding-left: 20px;
            padding-top: 20px;

        }

        #reportCont {
            float: left;
            padding: 6px;
        }

        .datePicker {
            max-width: 120px;
        }

        /*#reportFilterToggle {*/
            /*width: 20px;*/
            /*height: 600px;*/
            /*float: left;*/
            /*background: linear-gradient(#ffffff, cornflowerblue);*/
            /*cursor: pointer;*/
        /*}*/

    </style>

    <script>
        $(document).ready(function () {

            $.getJSON("/jiraprojects/source")
                .done(function(projectData){
                    $.each(projectData, function (i, data) {
                        var projectId = 'project' + data["key"];
                        var divString = "<div id='" + projectId + "' class='projectTile' data-id='" + data["key"] + "'>" + data["name"] + "<div style='clear:both'/><img src='" + data["avatarUrls"]["48x48"] + "'/>" + "</div>";
                        $("#coverflowCont").append(divString);
                        //Project Selection handler...
                        $("#" + projectId).on('click', function (e) {
                            $(".projectTileSelected").removeClass("projectTileSelected");
                            $(this).addClass("projectTileSelected");
                            window.selectedProjectId = $(this).data("id");
                        });
                    });
                    $("#coverflowCont").coverflow({
                        width: 1200
                    });
                    $(".projectTile:first").trigger('click');
                })
                .fail(function(jqxhr, textStatus, error){
                    alert('Error: ' + textStatus + '\n' + error);
                });

            //Get Teams
            $("#teamSelector").kendoMultiSelect({
                placeholder: "Team Filter...",
                dataValueField: "_id",
                dataTextField: "name",
                autoBind: false,
                dataSource: {
                    transport: {
                        read: {
                            url: "/teams/",
                            dataType: "json",
                            type: "GET",
                            contentType: "application/json"
                        }
                    }
                }
            });

            //Datepickers
            $("#fromDate").kendoDatePicker({
                format: "MM/dd/yyyy",
                value: ""
            });
            $("#toDate").kendoDatePicker({
                format: "MM/dd/yyyy",
                value: ""
            });

            $("#reportFilterToggle").on('click', function (e) {
                //$("#reportFilterPanel").slideToggle(200);
                if ($("#filterWidgets").is(":visible")){
                    $("#filterWidgets").slideUp(200, function(){
                        $("#reportFilterToggle").text("Show");
                    });
                }
                else{
                    $("#filterWidgets").slideDown(200, function(){
                        $("#reportFilterToggle").text("Hide");
                    });
                }
            });

            $("#btnSearch").on('click', function(e){
                e.preventDefault();
                getJiraIssues(window.selectedProjectId, $("#fromDate").val(), $("#toDate").val());
            });

            function getJiraIssues(projectId, startDate, endDate){
                $.getJSON('/jiraissues/source?projectId=' + encodeURIComponent(projectId) + '&startDate=' + reformatDateForJira(startDate) + '&endDate=' + reformatDateForJira(endDate))
                        .done(function(jiraIssues){
                            console.log(jiraIssues);

                            //Test Code...
                            $.getJSON('/jiraissues/burndown?projectId=' + encodeURIComponent(projectId) + '&startDate=' + reformatDateForJira(startDate) + '&endDate=' + reformatDateForJira(endDate))
                                    .done(function(burndownData){
                                        console.log('MongoDB issue data...');
                                        console.log(burndownData);
                                        $("#reportFilterToggle").trigger('click');
                                        var resolvedCount = 0;
                                        var openCount = 0;
                                        var reviewCount = 0;
                                        var onHoldCount = 0;
                                        var approvedCount = 0;

                                        $.each(burndownData, function(i, data){
                                            var status = data["fields"]["status"][0].name;
                                            switch(status) {
                                                case 'Open' :
                                                    openCount += 1;
                                                    break;
                                                case 'Closed' :
                                                    resolvedCount += 1;
                                                    break;
                                                case 'In Review' :
                                                    reviewCount += 1;
                                                    break;
                                                case 'Approved' :
                                                    approvedCount += 1;
                                                case 'On Hold' :
                                                    onHoldCount += 1;
                                                default:
                                                    openCount += 1;
                                            }
                                        });
                                        //Chart...
                                        var chartOptions = {
                                            chart: {
                                                renderTo: renderTarget
                                            },
                                            colorAxis: {
                                                minColor: '#FFFFFF',
                                                maxColor: Highcharts.getOptions().colors[0]
                                            },
                                            credits: {
                                                enabled: false
                                            },
                                            title: {
                                                text: 'Project Progress Overview'
                                            },
                                            series: [{
                                                type: "treemap",
                                                layoutAlgorithm: "squarified",
                                                data: [
                                                    {
                                                        name: 'Open',
                                                        value: openCount,
                                                        color: '#6699FF'
                                                    },
                                                    {
                                                        name: 'Closed/Resolved',
                                                        value: resolvedCount,
                                                        color: '#FFFF66'
                                                    },
                                                    {
                                                        name: 'On Hold',
                                                        value: onHoldCount,
                                                        color: '#FF6666'
                                                    },
                                                    {
                                                        name: 'Approved',
                                                        value: approvedCount,
                                                        color: '#FF6666'
                                                    },
                                                    {
                                                        name: 'In Review',
                                                        value: reviewCount,
                                                        color: '#669999'
                                                    }
                                                ]
                                            }]
                                        };
                                        var chart = new Highcharts.Chart(chartOptions);
                                    })
                                    .fail(function(jqxhr, textStatus, error){
                                        alert('Error: ' + textStatus + '\n' + error);
                                    });
                        })
                        .fail(function(jqxhr, textStatus, error){
                            alert('Error: ' + textStatus + '\n' + error);
                        });
            }

        });

    </script>
</head>

<body>

<div id="reportFilters">
    <div id="reportFilterPanel" style="width: 1300px; float: left;">
        <div id="filterWidgets">
            <div style="width:1260px; height: 140px;">
                <div id="coverflowCont">
                </div>
            </div>
            <div style="clear: both; height: 20px;"></div>
            <div style="float: left;">
                <label for="fromDate">From</label>
                <input id="fromDate" class="datePicker">
                <label for="toDate">To</label>
                <input id="toDate" class="datePicker">
            </div>
            <div style="clear: both; height: 20px;"></div>
            <div style="width:290px; max-height: 160px;">
                <select id="teamSelector" multiple="multiple">
                </select>
            </div>
        </div>
        <div style="margin-top:6px;">
            <a id="reportFilterToggle" class="btn btn-default pull-left" style="margin-left: 20px; margin-bottom:20px;">Hide</a>
            <a id="btnSearch" class="btn btn-default pull-right" style="margin-right: 20px;margin-bottom: 20px;"><span class="glyphicon glyphicon-search"></span>&nbsp;Search</a>
        </div>
    </div>
</div>

<div id="renderTarget" style="width:1300px; height: 570px;">

</div>

</body>
</html>
